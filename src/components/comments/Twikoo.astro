---
/**
 * Twikoo 评论组件（Astro 稳定版）
 * 适用于：SSG / SSR / View Transitions
 */

const {
  envId,
  lang = 'zh-CN',
  containerId = 'tcomments'
} = Astro.props
---

<div id={containerId} class="twikoo-container"></div>

<script is:inline>
(function () {
  const CONTAINER_ID = {JSON.stringify(containerId)}
  const ENV_ID = {JSON.stringify(envId)}
  const LANG = {JSON.stringify(lang)}

  function initTwikoo() {
    const el = document.getElementById(CONTAINER_ID)
    if (!el) return

    // 防止重复初始化
    if (el.dataset.twikooInited === 'true') return
    el.dataset.twikooInited = 'true'

    // 已加载 twikoo
    if (window.twikoo) {
      window.twikoo.init({
        envId: ENV_ID,
        el: `#${CONTAINER_ID}`,
        path: location.pathname,
        lang: LANG,
      })
      return
    }

    // 动态加载脚本
    const script = document.createElement('script')
    script.src = 'https://cdn.jsdelivr.net/npm/twikoo@latest/dist/twikoo.all.min.js'
    script.async = true

    script.onload = () => {
      if (!window.twikoo) return
      window.twikoo.init({
        envId: ENV_ID,
        el: `#${CONTAINER_ID}`,
        path: location.pathname,
        lang: LANG,
      })
    }

    document.head.appendChild(script)
  }

  // 首次加载
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initTwikoo, { once: true })
  } else {
    initTwikoo()
  }

  // Astro View Transitions 支持
  document.addEventListener('astro:page-load', () => {
    const el = document.getElementById(CONTAINER_ID)
    if (el) {
      el.dataset.twikooInited = 'false'
      initTwikoo()
    }
  })
})()
</script>

<style>
.twikoo-container {
  margin-top: 2rem;
}
</style>
